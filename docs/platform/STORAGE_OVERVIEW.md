# 平台存储总览

## 概述

平台采用多数据库架构，根据数据特性和使用场景选择最合适的存储方案。本文档提供了所有存储系统的总览和选择指南。

## 存储架构图

```
┌─────────────────────────────────────────────────────────┐
│                    应用层                                │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│   MongoDB    │  │    Redis     │  │  ChromaDB    │
│  (持久化)    │  │  (缓存/队列) │  │  (向量库)    │
└──────────────┘  └──────────────┘  └──────────────┘
        │                 │                 │
        ▼                 ▼                 ▼
   文档数据           临时数据           向量数据
   配置数据           会话数据           嵌入数据
   历史数据           队列数据           元数据
```

## 存储系统对比

| 特性 | MongoDB | Redis | ChromaDB |
|------|---------|-------|----------|
| **主要用途** | 持久化数据存储 | 缓存和队列 | 向量搜索 |
| **数据类型** | 文档数据 | 键值对、列表、集合 | 向量嵌入 |
| **持久化** | ✅ 是 | ✅ 可选 | ✅ 是 |
| **查询能力** | 复杂查询、聚合 | 简单键值查询 | 向量相似度搜索 |
| **性能** | 中等 | 极高 | 中等 |
| **容量** | 大（TB级） | 小（GB级） | 中（GB级） |
| **适用场景** | 业务数据、配置 | 缓存、会话、队列 | 知识库、语义搜索 |

## 存储选择指南

### 何时使用 MongoDB

✅ **适合存储**:
- 用户信息、权限数据
- 股票基础数据、历史数据
- 分析任务、分析报告
- 系统配置、平台配置
- 操作日志、审计日志
- 需要复杂查询的数据
- 需要持久化的重要数据

❌ **不适合存储**:
- 临时缓存数据
- 实时队列数据
- 向量嵌入数据

### 何时使用 Redis

✅ **适合存储**:
- 会话信息（用户登录状态）
- 缓存数据（查询结果、计算结果）
- 任务队列（待处理任务）
- 实时状态（任务进度、Worker心跳）
- 速率限制计数
- 分布式锁
- PubSub消息

❌ **不适合存储**:
- 大量历史数据
- 复杂查询需求
- 向量数据
- 需要持久化的核心业务数据

### 何时使用 ChromaDB

✅ **适合存储**:
- 文档向量嵌入
- 知识库内容
- 需要语义搜索的文本
- 文档元数据

❌ **不适合存储**:
- 结构化业务数据
- 缓存数据
- 队列数据
- 非向量数据

## 数据流转

### 典型数据流

```
1. 用户请求
   ↓
2. Redis检查缓存
   ├─ 命中 → 直接返回
   └─ 未命中 → 继续
   ↓
3. MongoDB查询数据
   ↓
4. 处理数据
   ↓
5. Redis写入缓存
   ↓
6. 返回结果
```

### 知识库数据流

```
1. 上传文档
   ↓
2. MongoDB存储文档元数据
   ↓
3. 文档解析和分块
   ↓
4. 生成向量嵌入
   ↓
5. ChromaDB存储向量和元数据
   ↓
6. 完成
```

### 分析任务数据流

```
1. 创建分析任务
   ↓
2. MongoDB存储任务信息
   ↓
3. Redis队列添加任务
   ↓
4. Worker从队列获取任务
   ↓
5. Redis更新任务进度
   ↓
6. MongoDB存储分析结果
   ↓
7. Redis缓存结果
   ↓
8. 完成
```

## 数据一致性

### 最终一致性策略

1. **MongoDB为主**: 核心数据以MongoDB为准
2. **Redis缓存**: 缓存数据定期同步或失效
3. **ChromaDB独立**: 向量数据独立存储，通过document_id关联

### 缓存失效策略

- **TTL过期**: 设置合理的TTL自动失效
- **主动失效**: 数据更新时主动删除缓存
- **版本控制**: 使用版本号判断缓存有效性

## 备份策略

### MongoDB备份
- **频率**: 每日全量 + 每小时增量
- **方式**: mongodump + 压缩
- **存储**: 对象存储或专用备份服务器
- **保留**: 30天

### Redis备份
- **频率**: 每日RDB快照
- **方式**: RDB + AOF
- **存储**: 对象存储
- **保留**: 7天

### ChromaDB备份
- **频率**: 每日全量备份
- **方式**: 目录复制
- **存储**: 对象存储
- **保留**: 30天

## 性能优化

### MongoDB优化
- 合理设计索引
- 使用投影减少数据传输
- 批量操作减少网络往返
- 连接池管理

### Redis优化
- 使用Pipeline批量操作
- 合理设置TTL
- 选择合适的数据结构
- 连接池管理

### ChromaDB优化
- 批量添加文档
- 为常用查询字段建立索引
- 合理设置分块大小
- 定期重建索引

## 监控指标

### MongoDB监控
- 连接数
- 查询性能
- 存储使用率
- 索引使用率

### Redis监控
- 内存使用率
- 连接数
- 命中率
- 队列长度

### ChromaDB监控
- 集合数量
- 文档数量
- 存储大小
- 查询性能

## 扩展性规划

### 水平扩展
- **MongoDB**: 分片集群
- **Redis**: Redis Cluster
- **ChromaDB**: 分布式部署

### 垂直扩展
- 增加服务器内存和CPU
- 使用SSD提升I/O性能
- 优化查询和索引

## 安全考虑

### 访问控制
- MongoDB: RBAC权限控制
- Redis: 密码认证
- ChromaDB: 文件系统权限

### 数据加密
- 传输加密: TLS/SSL
- 存储加密: 敏感数据加密存储
- 备份加密: 备份文件加密

### 审计日志
- 记录所有数据操作
- 定期审计日志
- 异常告警

## 总结

平台采用多数据库架构，充分发挥各数据库的优势：

- **MongoDB**: 持久化存储核心业务数据
- **Redis**: 高性能缓存和队列管理
- **ChromaDB**: 向量搜索和知识库管理

通过合理的数据分布和缓存策略，可以确保系统的高性能、高可用性和可扩展性。

## 相关文档

- [MongoDB存储规划](./MONGODB_STORAGE_PLAN.md)
- [Redis存储规划](./REDIS_STORAGE_PLAN.md)
- [ChromaDB存储规划](./CHROMADB_STORAGE_PLAN.md)

